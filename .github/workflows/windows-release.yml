name: Windows Release

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Release tag (e.g. v5.1.2)"
        required: true
        type: string
      prerelease:
        description: "Mark as pre-release"
        required: false
        default: false
        type: boolean
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-installers:
    name: Build NSIS installer (${{ matrix.arch }})
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            rust_target: x86_64-pc-windows-msvc
          - arch: ARM64
            rust_target: aarch64-pc-windows-msvc

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_target }}

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2

      - name: Setup NSIS
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $candidatePaths = @(
            "${env:ProgramFiles(x86)}\NSIS\makensis.exe",
            "${env:ProgramFiles}\NSIS\makensis.exe"
          )

          $makensis = $candidatePaths | Where-Object { Test-Path -LiteralPath $_ } | Select-Object -First 1

          if (-not $makensis) {
            $version = "3.10"
            $zipUrl = "https://downloads.sourceforge.net/project/nsis/NSIS%203/$version/nsis-$version.zip"
            $zipPath = Join-Path $env:RUNNER_TEMP "nsis-$version.zip"
            $extractDir = Join-Path $env:RUNNER_TEMP "nsis-$version"

            Invoke-WebRequest -Uri $zipUrl -OutFile $zipPath
            Expand-Archive -Path $zipPath -DestinationPath $extractDir -Force

            $found = Get-ChildItem -Path $extractDir -Recurse -Filter "makensis.exe" | Select-Object -First 1
            if ($found) {
              $makensis = $found.FullName
            }
          }

          if (-not $makensis -or -not (Test-Path -LiteralPath $makensis)) {
            throw "makensis.exe not found after NSIS setup"
          }

          "NSIS_EXE=$makensis" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Build release binaries
        run: cargo build --release --target ${{ matrix.rust_target }}

      - name: Create dist directory
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null

      - name: Build NSIS installer
        shell: pwsh
        run: |
          & "$env:NSIS_EXE" "/DARCH=${{ matrix.arch }}" "installer.nsi"

      - name: Upload installer artifact
        if: ${{ github.actor != 'nektos/act' }}
        uses: actions/upload-artifact@v4
        with:
          name: installer-${{ matrix.arch }}
          path: dist/CBXShell-rs-Setup-*-${{ matrix.arch }}.exe
          if-no-files-found: error

      - name: Preview installer output (act)
        if: ${{ github.actor == 'nektos/act' }}
        shell: pwsh
        run: |
          Get-ChildItem -Path "dist/CBXShell-rs-Setup-*-${{ matrix.arch }}.exe" |
            Select-Object FullName, Length |
            Format-Table -AutoSize

  release:
    name: Publish GitHub Release
    if: ${{ github.actor != 'nektos/act' }}
    needs: build-installers
    runs-on: windows-latest

    steps:
      - name: Download installer artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          pattern: installer-*
          merge-multiple: true

      - name: Prepare bilingual release template
        shell: pwsh
        run: |
          $Tag = "${{ github.event_name == 'workflow_dispatch' && inputs.tag_name || github.ref_name }}"
          Add-Content -Path $env:GITHUB_ENV -Value "RELEASE_TAG=$Tag"
          Add-Content -Path $env:GITHUB_ENV -Value "RELEASE_NAME_EN=CBXShell-rs $Tag"
          Add-Content -Path $env:GITHUB_ENV -Value "RELEASE_NAME_KO=CBXShell-rs $Tag ë¦´ë¦¬ì¦ˆ"

          $Body = @"
          ## ğŸ‡ºğŸ‡¸ Release Overview
          - This release includes NSIS installers for **x86-64 (x64)** and **ARM64** Windows.
          - Please choose the installer that matches your system architecture.

          ## ğŸ‡°ğŸ‡· ë¦´ë¦¬ì¦ˆ ì•ˆë‚´
          - ì´ë²ˆ ë¦´ë¦¬ì¦ˆì—ëŠ” Windowsìš© **x86-64(x64)** ë° **ARM64** NSIS ì„¤ì¹˜ íŒŒì¼ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
          - ì‚¬ìš© ì¤‘ì¸ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ì— ë§ëŠ” ì„¤ì¹˜ íŒŒì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.

          ### Installers / ì„¤ì¹˜ íŒŒì¼
          - `CBXShell-rs-Setup-<version>-x64.exe`
          - `CBXShell-rs-Setup-<version>-ARM64.exe`

          ---
          _Auto-generated commit-based release notes are attached below._
          _ì•„ë˜ì—ëŠ” ì»¤ë°‹ ê¸°ë°˜ ìë™ ìƒì„± ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ê°€ ì´ì–´ì§‘ë‹ˆë‹¤._
          "@

          $Body | Set-Content -Path release_body.md -Encoding utf8

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: |
            ${{ env.RELEASE_NAME_EN }}
            ${{ env.RELEASE_NAME_KO }}
          body_path: release_body.md
          files: dist/CBXShell-rs-Setup-*.exe
          generate_release_notes: true
          draft: false
          prerelease: ${{ github.event_name == 'workflow_dispatch' && inputs.prerelease || false }}
